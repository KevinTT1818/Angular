<div class="blog-detail-container">
  @if (isLoading()) {
    <!-- åŠ è½½çŠ¶æ€ -->
    <div class="loading">
      <div class="spinner"></div>
      <p>åŠ è½½ä¸­...</p>
    </div>
  } @else if (blog()) {
    <!-- åšå®¢å†…å®¹ -->
    <article class="blog-article">
      <!-- å¤´éƒ¨ä¿¡æ¯ -->
      <header class="blog-header">
        <div class="container">
          <!-- é¢åŒ…å±‘å¯¼èˆª -->
          <nav class="breadcrumb">
            <a routerLink="/blogs">åšå®¢é¦–é¡µ</a>
            <span>/</span>
            <a [routerLink]="['/blogs']" [queryParams]="{category: blog()!.categoryId}">
              {{ blog()!.category.name }}
            </a>
            <span>/</span>
            <span>{{ blog()!.title }}</span>
          </nav>
          
          <!-- æ ‡é¢˜ -->
          <h1 class="article-title">{{ blog()!.title }}</h1>
          
          <!-- å…ƒä¿¡æ¯ -->
          <div class="article-meta">
            <div class="author-info">
              @if (blog()!.authorAvatar) {
                <img [src]="blog()!.authorAvatar" [alt]="blog()!.author" class="avatar">
              }
              <div>
                <div class="author-name">{{ blog()!.author }}</div>
                <div class="publish-date">
                  å‘å¸ƒäº {{ blog()!.publishedAt | dateFormat }}
                  @if (blog()!.updatedAt > blog()!.publishedAt) {
                    Â· æ›´æ–°äº {{ blog()!.updatedAt | dateFormat }}
                  }
                </div>
              </div>
            </div>
            
            <div class="article-stats">
              <span title="æµè§ˆé‡">ğŸ‘ï¸ {{ blog()!.viewCount }}</span>
              <span title="ç‚¹èµæ•°">â¤ï¸ {{ blog()!.likeCount }}</span>
              <span title="è¯„è®ºæ•°">ğŸ’¬ {{ blog()!.commentCount }}</span>
            </div>
          </div>
          
          <!-- æ ‡ç­¾ -->
          <div class="article-tags">
            @for (tag of blog()!.tags; track tag) {
              <span class="tag">#{{ tag }}</span>
            }
          </div>
        </div>
      </header>
      
      <!-- å°é¢å›¾ -->
      @if (blog()!.coverImage) {
        <div class="cover-image">
          <img [src]="blog()!.coverImage" [alt]="blog()!.title">
        </div>
      }
      
      <!-- ä¸»ä½“å†…å®¹ -->
      <div class="container">
        <div class="content-wrapper">
          <!-- å·¦ä¾§ç›®å½• -->
          @if (tocItems().length > 0) {
            <aside class="toc-sidebar">
              <div class="toc-container">
                <h3>ç›®å½•</h3>
                <nav class="toc-nav">
                  @for (item of tocItems(); track item.id) {
                    <a 
                      (click)="scrollToSection(item.id)"
                      [class.active]="activeSection() === item.id"
                      [style.padding-left.px]="(item.level - 1) * 16"
                      class="toc-link">
                      {{ item.text }}
                    </a>
                  }
                </nav>
              </div>
            </aside>
          }
          
          <!-- æ–‡ç« å†…å®¹ -->
          <div class="article-content">
            <markdown 
              [data]="blog()!.content"
              class="markdown-body">
            </markdown>
            
            <!-- åº•éƒ¨æ“ä½œæ  -->
            <div class="article-actions">
              <button 
                (click)="toggleLike()"
                [class.liked]="isLiked()"
                class="action-btn like-btn">
                {{ isLiked() ? 'â¤ï¸' : 'ğŸ¤' }} 
                {{ isLiked() ? 'å·²èµ' : 'ç‚¹èµ' }} 
                ({{ blog()!.likeCount }})
              </button>
              
              <button (click)="toggleCommentForm()" class="action-btn">
                ğŸ’¬ è¯„è®º ({{ blog()!.commentCount }})
              </button>
              
              <div class="share-dropdown">
                <button class="action-btn">ğŸ”— åˆ†äº«</button>
                <div class="share-menu">
                  <button (click)="share('twitter')">Twitter</button>
                  <button (click)="share('facebook')">Facebook</button>
                  <button (click)="share('linkedin')">LinkedIn</button>
                  <button (click)="share('weibo')">å¾®åš</button>
                  <button (click)="copyLink()">å¤åˆ¶é“¾æ¥</button>
                </div>
              </div>
            </div>
            
            <!-- è¯„è®ºè¡¨å• -->
            @if (showCommentForm()) {
              <div class="comment-form-container">
                <h3>å‘è¡¨è¯„è®º</h3>
                <form [formGroup]="commentForm" (ngSubmit)="submitComment()">
                  <div class="form-row">
                    <div class="form-group">
                      <input 
                        type="text" 
                        formControlName="author"
                        placeholder="å§“å *"
                        class="form-control">
                      @if (commentForm.get('author')?.invalid && commentForm.get('author')?.touched) {
                        <span class="error">è¯·è¾“å…¥å§“å</span>
                      }
                    </div>
                    
                    <div class="form-group">
                      <input 
                        type="email" 
                        formControlName="email"
                        placeholder="é‚®ç®± *"
                        class="form-control">
                      @if (commentForm.get('email')?.invalid && commentForm.get('email')?.touched) {
                        <span class="error">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±</span>
                      }
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <textarea 
                      formControlName="content"
                      placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."
                      rows="5"
                      class="form-control"></textarea>
                    @if (commentForm.get('content')?.invalid && commentForm.get('content')?.touched) {
                      <span class="error">è¯„è®ºå†…å®¹è‡³å°‘5ä¸ªå­—ç¬¦</span>
                    }
                  </div>
                  
                  <div class="form-actions">
                    <button 
                      type="button"
                      (click)="showCommentForm.set(false)"
                      class="btn btn-secondary">
                      å–æ¶ˆ
                    </button>
                    <button 
                      type="submit"
                      [disabled]="commentForm.invalid || isSubmittingComment()"
                      class="btn btn-primary">
                      {{ isSubmittingComment() ? 'æäº¤ä¸­...' : 'å‘è¡¨è¯„è®º' }}
                    </button>
                  </div>
                </form>
              </div>
            }
            
            <!-- è¯„è®ºåˆ—è¡¨ -->
            @if (comments().length > 0) {
              <div class="comments-section">
                <h3>è¯„è®º ({{ comments().length }})</h3>
                @for (comment of comments(); track comment.id) {
                  <div class="comment-item">
                    <div class="comment-header">
                      <span class="comment-author">{{ comment.author }}</span>
                      <span class="comment-date">{{ comment.createdAt | dateFormat }}</span>
                    </div>
                    <div class="comment-content">{{ comment.content }}</div>
                    
                    <!-- å›å¤ -->
                    @if (comment.replies && comment.replies.length > 0) {
                      <div class="comment-replies">
                        @for (reply of comment.replies; track reply.id) {
                          <div class="comment-item reply">
                            <div class="comment-header">
                              <span class="comment-author">{{ reply.author }}</span>
                              <span class="comment-date">{{ reply.createdAt | dateFormat }}</span>
                            </div>
                            <div class="comment-content">{{ reply.content }}</div>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }
            
            <!-- ç›¸å…³æ–‡ç«  -->
            @if (relatedBlogs().length > 0) {
              <div class="related-blogs">
                <h3>ç›¸å…³æ–‡ç« </h3>
                <div class="related-grid">
                  @for (relatedBlog of relatedBlogs(); track relatedBlog.id) {
                    <div class="related-card" (click)="goToBlog(relatedBlog.id)">
                      @if (relatedBlog.coverImage) {
                        <img [src]="relatedBlog.coverImage" [alt]="relatedBlog.title">
                      }
                      <div class="related-info">
                        <h4>{{ relatedBlog.title }}</h4>
                        <p>{{ relatedBlog.excerpt | slice:0:80 }}...</p>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </article>
  }
</div>